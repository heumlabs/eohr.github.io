# BDD

# 프로젝트 개요 & 요구사항
- 팀드라이브 전체를 재구현해야 하는 프로젝트를 1개월여간 진행함
- 서비스가 제공해야 하는 정확한 스펙이 정의, 문서화 되어 있지 않다... 🙃
    - 온보딩이 너무 고되다.
- 잘 정착되어 가고 있는 QA와의 커뮤니케이션 비용을 어떻게 하면 낮출 수 있을까?
- 빡빡한 단위 테스트가 오히려 개발 속도를 늦추기도 한다.
- ==뭐가 어찌 되었든 최종 서비스 되야 하는 기능은 꼭! 기필코! 무슨일이 있어도 보장하자!==
- 고객의 관점에서 개발해보자

## 왜 BDD여야 하는가?
- 제공하는 기능과 시나리오 기반으로 
- 간단한 BDD 설명
	- 구성요소
		- 기능(feature) - 시나리오(scenario) - 단계(steps, given / when / then) - 테스트 코드

---

# 돌입, 시행착오s
### Spec. 리버스 엔지니어링 -> 요구사항 정의
- API 엔드포인트들과 태스크 등 서비스 인터페이스를 중심으로 서비스 요구사항을 역으로 추출
- 플로우 차트

### 갈팡질팡 feature 정의 -> 관점의 전환
- 단위테스트(unittest) 작성에 익숙하다 보니 기능(feature)과 시나리오를 작성할 때 기술적 관점에서 작성하게 됨... DB에 값이 어떻고, API에 파라메터가 저떻고...
- 단위테스트와 다를바가 없어짐
	- Before
- ☑️ 개발자나 단위 기능과 세부구현 관점이 아닌, 서비스를 제공받는 고객이나, 다른 서비스의 입장에서 상황별로 어떤 서비스를 받게 되는지 적어보자.
	- After

### given을 재사용 해야 할까?
- 개발자이다 보니 코드의 재사용성을 생각하게됨
- 공통적인 given 절을 conftest 등으로 추출, 코드 재사용성 ⬆️, 시나리오 이해도 ⬇️
- But, given을 conftest에 넣어도 잘 활용이 되지 않는다.
    - Before
- ☑️ given은 중복되더라도 재사용 하지 않는다.
- ☑️ fixture나 fixture helper는 공통으로 구현하되, 각 시나리오의 given은 좀 중복 되더라도 맥락 파악을 위해 가능하면 시나리오 내에 선언하고 공통으로 추출, 구현된 fixture 모듈을 가져다 쓰자.
    - After

### Feature 파일은 꼭 같이 적고 시작하자
- feature 파일과 테스트 파일이 flat하게 작성이 되었다. 전체 기능에 대한 맥락을 파악하기 어렵다.
	- Before
- ☑️ feature 파일과 test 파일들을 기능적으로 분류하여 구조적으로 정리한다.
    - After

### 뒤죽박죽 given, when, then
- pytest-bdd가 정의된 step 구문을 기준으로 함수를 너무 잘 찾아주다 보니까 막 때려 넣어도 어딘가 존재하기만 하면 알아서 찾아서 끼워 맞춰서 테스트를 잘 돌려줌.
- 작성 할때는 편한데, 문제가 발생했을때 한 시나리오에 대한 given, when, then을 정리해서 보기가 어려움
    - Before
- ☑️ 결국 테스트 코드도 사람이 읽어야 하는 코드이니 맥락을 파악하기 위해서 최대한 시나리오 단위로 코드를 정리하자.
- ~test 파일에 대한 구조를 feature -> folder, scenario -> test file로 정리하자.~
- Feature 파일과 구조를 맞춘다.
    - After

### pytest-bdd의 templating
- gherkin syntax의 scenario outline과 example
- gherkin syntax와 다른 pytest-bdd의 template
- <> vs {} -> 아마도 python string format을 사용해서 example로 치환하는게 아닐까?
- pytest-bdd의 파서를 작성하면 동일하게 <>를 token으로 사용 가능... 하지만 거기까진 좀 오버인가?
- IDE 지원이 조금 더 되면 좋겠다...

### pytest-bdd & behave
- pytest-bdd 선정 이유: 기존 사용중인 테스트 프레임워크인 pytest와의 호환성
- 어차피 둘 다 gherkin syntax로 작성하는게 그닥 달라보이지 않음

---

## 결론 - 만족
- 서비스가 제공하는 기능 목록을 갖게 되었다.
- 세부적인 개발에 몰입하다 보면 지금 만드는 이 기능이 실제로는 어떤 맥락속에 있는지 잊고 구현에만 집중하게 되는 경우가 많은데, 서비스를 받는 입장에서 기능과 시나리오와 테스트 코드를 작성하다 보면 큰 맥락 속에서 기능을 구현하게 된다.
- 큰 흐름이 담긴 flowchart와 feature 파일의 시나리오를 기반으로 QA에 서비스와 기능에 대한 컨텍스트 전달이 가능했음 - 커뮤니케이션 비용 ⬇️
- 커버리지 확인 해보자.